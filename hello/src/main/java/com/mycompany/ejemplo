00:55:15.155 [main] INFO org.springframework.test.context.support.AnnotationConfigContextLoaderUtils -- Could not detect default configuration classes for test class [myproject.controller.ClientControllerTest]: ClientControllerTest does not declare any static, non-private, non-final, nested classes annotated with @Configuration.
00:55:15.206 [main] INFO org.springframework.boot.test.context.SpringBootTestContextBootstrapper -- Found @SpringBootConfiguration myproject.MyProjectApplication for test class myproject.controller.ClientControllerTest
00:55:15.253 [main] INFO org.springframework.boot.devtools.restart.RestartApplicationListener -- Restart disabled due to context in which it is running
OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
2024-03-10T00:55:16.624+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : drop table if exists banks cascade 
2024-03-10T00:55:16.626+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : drop table if exists clients cascade 
2024-03-10T00:55:16.626+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : drop table if exists invoice_product cascade 
2024-03-10T00:55:16.626+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : drop table if exists invoices cascade 
2024-03-10T00:55:16.626+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : drop table if exists products cascade 
2024-03-10T00:55:16.628+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : create table banks (amount float(53) not null, available boolean not null, transaction integer, id bigint generated by default as identity, id_client bigint, account_number varchar(255), name varchar(255), primary key (id))
2024-03-10T00:55:16.631+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : create table clients (age integer not null, id bigint generated by default as identity, email varchar(255), last_name varchar(255), name varchar(255), primary key (id))
2024-03-10T00:55:16.631+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : create table invoice_product (id_factura bigint not null, id_product bigint not null)
2024-03-10T00:55:16.631+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : create table invoices (total_amount float(53) not null, type tinyint check (type between 0 and 5), date timestamp(6), id bigint generated by default as identity, id_client bigint, primary key (id))
2024-03-10T00:55:16.633+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : create table products (price float(53) not null, id bigint generated by default as identity, description varchar(255), name varchar(255), primary key (id))
2024-03-10T00:55:16.633+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : alter table if exists banks add constraint FKdjmgj9xe1w0pfwy0cfndldnr2 foreign key (id_client) references clients
2024-03-10T00:55:16.637+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : alter table if exists invoice_product add constraint FK9f4e2dwvpxh4ea9o8yr9so4cj foreign key (id_product) references products
2024-03-10T00:55:16.637+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : alter table if exists invoice_product add constraint FK6n97f675s6shwtbdeddepjp9d foreign key (id_factura) references invoices
2024-03-10T00:55:16.638+01:00 DEBUG 39709 --- [           main] org.hibernate.SQL                        : alter table if exists invoices add constraint FK9fbt36pf6epispvci1fnkvd4s foreign key (id_client) references clients

jakarta.servlet.ServletException: Request processing failed: java.lang.NullPointerException: Cannot invoke "myproject.model.entity.Client.getId()" because "client" is null

	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1022)
	at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:914)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:590)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.springframework.mock.web.MockFilterChain$ServletFilterProxy.doFilter(MockFilterChain.java:165)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.test.web.servlet.setup.MockMvcFilterDecorator.doFilter(MockMvcFilterDecorator.java:151)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:132)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:201)
	at myproject.controller.ClientControllerTest.givenAClientWithAllMandatoryParams_ThenSaveInTheBd(ClientControllerTest.java:52)
	at java.base/java.lang.reflect.Method.invoke(Method.java:568)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
Caused by: java.lang.NullPointerException: Cannot invoke "myproject.model.entity.Client.getId()" because "client" is null
	at myproject.controller.ClientController.save(ClientController.java:38)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:568)
	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:351)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.validation.beanvalidation.MethodValidationInterceptor.invoke(MethodValidationInterceptor.java:174)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
	at myproject.controller.ClientController$$SpringCGLIB$$0.save(<generated>)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:568)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:259)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:192)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:920)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:830)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	... 24 more


package myproject.controller;

import com.fasterxml.jackson.databind.ObjectMapper;
import myproject.mapper.ClientMapper;
import myproject.model.dto.ClientDto;
import myproject.model.entity.Client;
import myproject.model.request.ClientRequest;
import myproject.service.ClientService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;

import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@SpringBootTest
@AutoConfigureMockMvc
class ClientControllerTest {

    @Autowired
    MockMvc mvc;
    @MockBean
    private ClientService clientService;
    @MockBean
    ClientMapper clientMapper;
    ObjectMapper objectMapper;

    Client client;
    ClientDto clientDto;
    ClientRequest clientRequest;

    @BeforeEach
    void setUp(){
        objectMapper = new ObjectMapper();
        client = new Client(1L, "Jorge", "del Riego", "jorge@gmail.com", 26);
        clientRequest = new ClientRequest("Jorge", "del Riego", "jorge@gmail.com", 26);
        clientDto = new ClientDto("Jorge", "del Riego", "jorge@gmail.com", 26);
    }

    @Test
    void givenAClientWithAllMandatoryParams_ThenSaveInTheBd() throws Exception {
        when(clientMapper.toEntity(clientRequest)).thenReturn(client);
        when(clientMapper.toDto(client)).thenReturn(clientDto);

        mvc.perform(post("/api/clients")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(clientRequest)))
                .andExpect(status().isCreated());
    }
